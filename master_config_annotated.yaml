# ==============================================================================
# LBM-2D MRT-LES 模擬主設定檔 (Master Config - Annotated)
# ==============================================================================
# 本檔案提供了最詳盡的參數說明與調校建議。
# 適用於高階使用者進行物理參數微調與除錯。
#
# 注意事項:
# 1. 所有物理單位均為「晶格單位 (Lattice Units)」，即 dx=1, dt=1。
# 2. 為了保持數值穩定，請確保最大速度 u_lb < 0.1 (最好 < 0.05)。
# 3. 若模擬發散 (爆炸)，請優先檢查 nu 是否過小或 ghost_moments_s 是否需調高。
# ==============================================================================

simulation:
  # 模擬專案名稱，會影響輸出檔案的前綴
  name: "Re1600_rects"

  # ----------------------------------------------------------------------------
  # 1. 網格解析度 (Resolution)
  # ----------------------------------------------------------------------------
  # [說明]: 定義計算域的大小。
  # [影響]: 
  #   - 調大: 解析度提高，能捕捉更細微的渦流，物理準確度上升，但計算量呈平方增長 (N^2)。
  #   - 調小: 計算速度快，但雷諾數上限會受限 (因為 nu 不能無限小)。
  # [建議]: 測試用 512x256，生產用 2048x1024 或更高。
  nx: 2048
  ny: 1024

  # ----------------------------------------------------------------------------
  # 2. 核心物理參數 (Physics)
  # ----------------------------------------------------------------------------
  # [參數]: nu (運動黏滯係數, Kinematic Viscosity)
  # [公式]: Re = (u_char * L_char) / nu
  # [影響]: 
  #   - 調大 (> 0.02): 流體變得像蜂蜜，層流 (Laminar)，極其穩定。
  #   - 調小 (< 0.005): 流體像空氣，湍流 (Turbulence) 明顯，但數值容易不穩定 (發散)。
  # [極限]: D2Q9 MRT 下，nu 極限約在 0.001 左右。若需更高 Re，必須增加解析度 (nx, ny)。
  nu: 0.005

  # [參數]: characteristic_length (特徵長度)
  # [說明]: 代表障礙物的特徵寬度 (像素)。
  # [用途]: 僅用於後處理計算 Re, Cd, Cl，不影響模擬過程。
  characteristic_length: 160.0

  # ----------------------------------------------------------------------------
  # 3. 運算步數與批次 (Time Steps)
  # ----------------------------------------------------------------------------
  # [參數]: compute_step_size
  # [說明]: Python 與 GPU 同步的頻率。每隔 N 步，GPU 暫停並將控制權交回 Python (更新 GUI/寫檔)。
  # [影響]: 
  #   - 調大 (e.g. 500): 減少 CPU/GPU 切換開銷，模擬最快，但 GUI 更新率低 (看起來卡頓)。
  #   - 調小 (e.g. 1): 即時反應最流暢，但整體效能大幅下降。
  # [建議]: 20 ~ 100。
  compute_step_size: 50

  # [參數]: max_steps
  # [說明]: 模擬總步數。
  # [建議]: 根據流體穿過場景的時間 (Flow-through time) 估算。通常需要 5~10 次穿透時間才能達到統計穩態。
  max_steps: 1000000 

  # [參數]: warmup_steps
  # [說明]: 預熱步數。在此期間內：
  #   1. 入口速度會從 0 緩慢增加到設定值 (Ramp-up)，避免衝擊波。
  #   2. 不會進行數據寫入與穩定性檢查。
  # [建議]: 2000 ~ 5000。
  warmup_steps: 2000

  # ----------------------------------------------------------------------------
  # 4. 湍流模型與穩定性 (Turbulence & Stability)
  # ----------------------------------------------------------------------------
  # [參數]: smagorinsky_constant (Cs)
  # [說明]: LES (大渦模擬) 的次網格應力係數。
  # [影響]: 
  #   - 調大 (> 0.2): 增加人工黏滯性，抑制高頻震盪，圖像較模糊，但更穩定。
  #   - 調小 (< 0.1): 允許更多細碎渦流，圖像銳利，但容易發散。
  # [建議]: 標準值 0.1 ~ 0.2。若發散可暫時調至 0.25。
  smagorinsky_constant: 0.2

  # [參數]: ghost_moments_s
  # [說明]: MRT 模型中「鬼影模態 (高階矩)」的鬆弛率。這是消除「棋盤格/馬賽克噪音」的關鍵。
  # [影響]: 
  #   - 調大 (1.1 ~ 1.2): 強力壓制高頻噪音，畫面乾淨，穩定性高。
  #   - 調小 (1.0): 標準 MRT，但在低黏度下容易產生高頻震盪。
  # [建議]: 強烈建議設為 1.1 或 1.2。
  ghost_moments_s: 1.2

# ==========================================
#   輸出控制 (Outputs)
# ==========================================
outputs:
  # 是否開啟 Taichi 內建效能分析 (Kernel執行時間)
  enable_profiling: false

  # 1. 即時視窗顯示 (GUI)
  gui:
    enable: true
    # 必須是 compute_step_size 的倍數
    interval_steps: 100 
    # 視窗最大寬度，避免在高解析度螢幕上視窗太大
    max_size: 550 
    # 是否顯示 Sponge Layer (阻尼層) 與 Buffer (緩衝區) 的白色框線
    show_zone_overlay: true 
    # 視覺化時的高斯模糊半徑 (僅影響顯示，不影響物理)，設為 0 則顯示原始像素
    gaussian_sigma: 1.0 

  # 2. 影片錄製 (Video)
  video:
    enable: true
    # 錄影頻率。注意：頻率太高會產生巨型檔案並拖慢模擬。
    interval_steps: 100 
    fps: 30
    filename: "simulation_video.mp4"

  # 3. 深度學習數據集 (HDF5 Writer)
  dataset:
    enable: true
    interval_steps: 100
    folder: "outputs/simulation_data/batch_run_rects/"
    # 壓縮算法: 
    #   - "lzf": 極快，壓縮率普通 (適合即時寫入)
    #   - "gzip": 慢，壓縮率高 (適合硬碟空間受限)
    compression: "lzf" 
    # 儲存解析度: 為了節省空間，可將 2048x1024 的場縮小存成 512x256
    save_resolution: 512

# ==========================================
#   邊界與幾何 (Geometry & Boundary)
# ==========================================
boundary_condition:
  # 定義四個邊界的類型
  # 0: Inlet (速度入口), 1: Outlet (壓力出口), 2: Free-Slip (滑移壁/對稱), 3: No-Slip (固壁)
  # 順序: [Left, Right, Top, Bottom]
  type: [0, 2, 1, 2]
  
  # 定義對應的數值
  # 對於 Inlet: [u_x, u_y]
  # 對於 Outlet/Free-Slip: 通常忽略，填 [0, 0] 即可
  value:
    - [0.05, 0.0] # 左側入口速度 u=0.05 (LBM單位)
    - [0.0, 0.0]
    - [0.0, 0.0]
    - [0.0, 0.0]

mask:
  enable: true
  type: "png"
  # 是否反轉 Mask 顏色定義
  # false (預設): 黑色 (0) = 障礙物, 白色 (255) = 流體
  # true: 白色 (255) = 障礙物, 黑色 (0) = 流體
  invert: false
  # 預設 Mask 路徑 (若使用 run_multi_case 會被覆寫)
  path: "src/tools/rect_masks/mask_phys_r4_0017.png"

# ==========================================
#   區域定義 (Domain Zones)
# ==========================================
# 用於定義模擬場中不應被納入訓練數據的「工程區域」
domain_zones:
  # 上下邊界阻尼層厚度: 用於吸收反射波
  sponge_y: 64 
  # 右側出口阻尼層厚度: 用於確保出口流動平順
  sponge_x: 128 
  # 感興趣區域 (ROI) 外圍的緩衝: 避免邊界效應影響神經網絡訓練
  buffer: 64 
  # 入口緩衝區: 確保流場已充分發展
  inlet_buffer: 128