# 03_PyTorch 數據集準備計畫

本文件說明如何將 Taichi LBM-2D 生成的 HDF5 數據轉換為 PyTorch 訓練所需的 `Dataset` 格式。

## 1. HDF5 數據格式回顧

我們目前輸出的 HDF5 檔案結構如下 (`outputs/simulation_data/h5_SimData/`):

- **Dataset**: `turbulence` (T, 9, H, W) - 物理場 (MRT Moments)
- **Dataset**: `static_mask` (2, H, W) - 幾何特徵 (Mask, SDF)
- **Dataset**: `sum_vor` (H, W) - 累積渦度 (Target Label)
- **Attributes**: `config_json`, `stats_min`, `stats_max`

這是一個高度結構化且自包含 (Self-contained) 的格式，非常適合深度學習。

---

## 2. Dataset 類別設計

建議繼承 `torch.utils.data.Dataset` 實作一個 `LBMH5Dataset` 類別，直接讀取 HDF5 檔案。

### 核心邏輯
- **輸入 (X)**:
  - `static_mask`: 提供幾何邊界條件 (Shape: 2, H, W)。
  - `turbulence[t]`: 提供當前時刻的流場狀態 (Shape: 9, H, W)。
  - `Reynolds Number`: 從 Attributes 讀取並作為 Global Condition。
- **輸出 (Y)**:
  - `turbulence[t+1]`: 下一時刻的流場狀態 (用於預測任務)。
  - `sum_vor`: 累積渦度圖 (用於迴歸任務)。

### 程式碼範例 (Draft)

```python
import torch
import h5py
import numpy as np
from torch.utils.data import Dataset

class LBMH5Dataset(Dataset):
    def __init__(self, file_path, sequence_length=1):
        self.file_path = file_path
        self.sequence_length = sequence_length
        
        # 開啟檔案讀取 Metadata (不載入整個數據)
        with h5py.File(file_path, 'r') as f:
            self.total_frames = f['turbulence'].shape[0]
            self.static_mask = f['static_mask'][:] # 預先載入小量靜態數據
            self.reynolds = f.attrs['reynolds_number'] # 假設有此屬性

    def __len__(self):
        # 扣除序列長度，確保有足夠的 t+1 數據
        return self.total_frames - self.sequence_length

    def __getitem__(self, idx):
        with h5py.File(self.file_path, 'r') as f:
            # 讀取時序數據片段
            # X: t ~ t+seq_len-1
            x_seq = f['turbulence'][idx : idx + self.sequence_length]
            
            # Y: t+1 ~ t+seq_len (Next Step Prediction)
            y_seq = f['turbulence'][idx + 1 : idx + self.sequence_length + 1]

            # 轉為 Tensor
            x_tensor = torch.from_numpy(x_seq)
            y_tensor = torch.from_numpy(y_seq)
            mask_tensor = torch.from_numpy(self.static_mask)

            return {
                'x': x_tensor,
                'y': y_tensor,
                'mask': mask_tensor,
                're': self.reynolds
            }
```

---

## 3. 數據增強 (Data Augmentation)

雖然 LBM 數據具有物理守恆性，但我們仍可進行幾何變換增強：
- **隨機翻轉 (Flip)**: 上下翻轉 (Flip Ud) 需注意 y 分量速度與渦度符號的反轉。
- **隨機旋轉 (Rotate 90/180/270)**: 需同步旋轉向量場 (u, v)。
- **正規化 (Normalization)**: 使用 Attributes 中的 `stats_mean` 與 `stats_std` 進行 Z-Score 標準化。

---

## 4. 訓練策略

- **Autoregressive Training**: 使用模型預測的 t+1 作為 t+2 的輸入，訓練長期穩定性。
- **Physics-Informed Loss**: 加入物理約束 (如不可壓縮性 div(u)=0) 作為 Loss Function 的一部分。