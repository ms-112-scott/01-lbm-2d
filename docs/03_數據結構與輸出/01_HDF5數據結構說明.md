# LBM 模擬數據輸出格式說明 (HDF5) - 建築工程增強版

本文件詳細說明 `lbm_2d` 專案產生的 HDF5 (`.h5`) 數據結構。此格式兼顧 **深度學習模型訓練** 與 **建築風場工程分析**，包含完整的矩空間 (Moment Space) 演化軌跡與二階時域統計場。

## 1. 檔案位置與命名

* **預設路徑**: `outputs/simulation_data/` (依 Config 設定)。
* **命名規則**: `<SimulationName>_<MaskName>.h5`。

## 2. HDF5 數據結構概覽

HDF5 檔案採扁平化結構，包含動態序列、靜態幾何與關鍵統計指標。

```text
root (/)
├── turbulence           (Dataset) [T, 9, H, W] - 瞬時 MRT 矩場 (用於序列訓練)
├── static_mask          (Dataset) [2, H, W]    - 遮罩 (C0) 與 SDF (C1)
├── sum_vor              (Dataset) [H, W]       - 累積絕對渦度 (高能擾動區識別)
├── mean_vel_field           (Dataset) [9, H, W]    - 一階統計：時序平均矩場 (穩定流場)
├── mean_vel_sq_field    (Dataset) [H, W]       - 二階統計：速度平方平均 (陣風/TI 計算關鍵)
└── (Attributes)         - 全域元數據 (Config, 物理常數 Re/nu, 數據範圍)

```

---

## 3. Dataset 詳細說明

### 3.1 `turbulence` (瞬時演化場)

儲存 LBM 迭代中的過濾後瞬時數據。

* **Shape**: `(T, 9, H, W)`
* **通道意義**: 遵循標準 D2Q9 MRT 矩矩陣轉換。
* **Index 0 (rho)**: 密度。
* **Index 3, 5 (jx, jy)**: 動量 X, Y。
* **Index 7, 8 (pxx, pxy)**: 非平衡應力張量（反映局部剪切與陣風潛力）。



### 3.2 `mean_vel_sq_field` (二階統計場)

專為建築師分析 **「風場變化性」** 設計的指標。

* **Shape**: `(H, W)`
* **物理意義**: 每個網格點的 （速度模長平方的時域平均）。
* **用途**: 配合 `mean_vel_field` 可直接導出 **湍流強度 (TI)** 與 **Beaufort Scale (陣風級數)**，無需遍歷整個時序 Dataset。

### 3.3 `static_mask` (幾何約束)

* **Index 0 (binary_mask)**: 0 為流體，1 為固體建築。
* **Index 1 (sdf)**: 符號距離場。數值代表距離建築表面的格子數（內部為負），用於 Post-cal 邊界平滑與修正。

---

## 4. 關鍵分析指標計算 (Post-Calculation)

建築師關心的「顯性物理量」可由以下公式快速導出：

| 目標物理量 | 依賴 Dataset | 計算邏輯簡述 |
| --- | --- | --- |
| **平均風速 $\bar{U}$** | `mean_vel_field` |  $\sqrt{(\bar{j}_x/\bar{\rho})^2 + (\bar{j}_y/\bar{\rho})^2}$ |
| **渦度 $\omega$** | `turbulence` | $\frac{\partial (j_y/\rho)}{\partial x} - \frac{\partial (j_x/\rho)}{\partial y}$ (需計算空間梯度) |
| **湍流強度 $I$** | `mean_vel_field` + `mean_vel_sq` | $\sqrt{E[u^2] - \bar{u}^2} / \bar{u}$ |
| **陣風感 (Gust)** | `mean_vel_field` + `mean_vel_sq` | $\bar{u} + 3 \cdot \sigma_u$  (3-sigma 準則) |

---

## 5. Python 快速分析範例

```python
import h5py
import numpy as np

with h5py.File("simulation.h5", "r") as f:
    # 提取平均動量與平均速度平方
    mean_f = f["mean_vel_field"][:]
    E_u2 = f["mean_vel_sq_field"][:]
    
    # 計算平均速度 (u_bar)
    u_avg = mean_f[3] / mean_f[0]
    v_avg = mean_f[5] / mean_f[0]
    mag_avg = np.sqrt(u_avg**2 + v_avg**2)
    
    # 計算標準差 (陣風指標)
    # sigma = sqrt(E[u^2] - (E[u])^2)
    sigma = np.sqrt(np.maximum(E_u2 - mag_avg**2, 0))
    
    # 輸出建築師用的陣風指標 (Gust)
    gust_map = mag_avg + 3.0 * sigma

```