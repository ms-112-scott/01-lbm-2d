# 02_開發者技術指引 (Developer Guide)

本文件為 `LBM_MRT_LES` 專案的技術規格書與開發指引，旨在協助開發者理解系統架構、參數限制與模組開發要求。

## 1. 專案目標與技術路徑

**目標**: 開發一套基於深度學習 (DL) 的即時流體模擬器，用於建築風環境的快速迭代設計。
**核心思路**: 不直接使用 CFD 求解 (太慢)，而是採用 **「LBM 生成數據 $ightarrow$ DL 模型學習 $ightarrow$ 即時推理」** 的代理模型 (Surrogate Model) 策略。

### 技術棧
- **數據生成**: Python + Taichi (GPU) + MRT-LBM。
- **AI 核心**: PyTorch (UNet/ResNet/NCA)。
- **即時引擎**: Python (Accumulator Logic) + Taichi GUI。

---

## 2. 核心物理參數與限制 (Critical Parameters)

開發者必須嚴格遵守以下物理與數值限制，以確保數據的穩定性與正確性。

| 參數類別 | 參數名稱 | 數值 / 設定 | 說明 / 限制 |
| :--- | :--- | :--- | :--- |
| **物理環境** | 特徵尺度 ($L$) | $10 \sim 100 m$ | 建築物寬度 |
| | 物理黏度 ($
u_{air}$) | $1.5 	imes 10^{-5} m^2/s$ | 空氣黏度 |
| **空間離散化** | 網格解析度 ($\Delta x$) | **固定 (例如 0.1m)** | **硬限制**，不可隨意更改 |
| | 網格維度 | $256^2$ 或 $512^2$ | 配合 DL 模型的 Tensor 尺寸 |
| **LBM 數值** | 格子流速上限 ($u_{lb}$) | **< 0.1** | 為了降噪與穩定，嚴禁超過 0.1 (Mach < 0.1) |
| | 雷諾數處理 ($Re$) | 截斷至 $5000 \sim 10000$ | 不需要跑真實的高 $Re$ (e.g. $10^6$)，會導致發散 |
| **時間同步** | DL 採樣間隔 ($T_{sample}$) | **100 ~ 200 步** | 每隔 $N$ 步 LBM 存一筆數據 |

---

## 3. 模組開發詳細要求

### 3.1 模組 A：LBM 求解器 (Data Generator)

**路徑**: `src/lbm_mrt_les/engine/lbm_solver.py`

#### 開發重點
1.  **資料結構 (Data Layout)**:
    - 必須使用 **Structure of Arrays (SoA)** 以優化 GPU 記憶體存取。
    - Taichi 定義：`f = ti.Vector.field(9, dtype=ti.f32, shape=(nx, ny))`。
2.  **穩定性機制 (MRT Collision)**:
    - **嚴禁使用單鬆弛 BGK** (在粗網格下會炸)。
    - **關鍵參數**:
        - 物理黏度鬆弛 $s_{
u}$：由 $
u$ 決定。
        - 鬼影模態鬆弛 $s_{ghost}$：設定 **1.1 ~ 1.2**。這是消除高頻噪音、防止模擬崩潰的關鍵。
3.  **邊界條件**:
    - 建築物：Bounce-back (反彈)。
    - 邊界層：Sponge Layer (阻尼層) + Velocity Inlet + Neumann Outlet。

### 3.2 模組 B：深度學習模型 (The Surrogate)

**路徑**: `(待開發)`

#### 開發重點
1.  **輸入特徵**:
    - `Shape Mask` (建築物位置, Binary)。
    - `Velocity_X`, `Velocity_Y`, `Pressure` (來自 $t$ 時刻)。
2.  **輸出目標**:
    - `Velocity_X`, `Velocity_Y`, `Pressure` (預測 $t+1$ 時刻)。
3.  **數據標準化**:
    - LBM 輸出的速度通常很小 ($<0.1$)。**必須 Normalization** 到 $[-1, 1]$ 或 $[0, 1]$ 區間再餵給神經網路。

### 3.3 模組 C：即時渲染器 (Real-time Iterator)

**路徑**: `src/lbm_mrt_les/io/visualizer.py`

#### 開發重點
1.  **時間解耦循環 (The Game Loop)**:
    - 程式必須實作「累積器 (Accumulator)」邏輯。
    - $dt$ 是常數，不可變。
    - 透過 `accumulator += real_time_delta * speed_multiplier` 來控制播放速度。
2.  **Zero-Copy 傳輸**:
    - 使用 `taichi_field.to_torch()` 與 `taichi_field.from_torch()` 進行數據交換。
    - **避免**使用 `.numpy()`，這會導致 GPU $\leftrightarrow$ CPU 的資料搬運，嚴重拖慢 FPS。

---

## 4. 常見問題與除錯指南 (Troubleshooting)

**Q1: 為什麼模擬出來的渦流看起來比真實世界的大？**
- **原因**: 這是 2D 模擬的 **逆能量級聯 (Inverse Energy Cascade)** 現象。在 2D 中，小渦流傾向合併成大渦流。
- **對策**: 這是正常現象。對於建築風環境的快速評估 (舒適度、風口位置)，這種拓撲結構是可接受的。

**Q2: 模擬跑到一半出現 `NaN` 或花屏？**
- **檢查點 1**: $u_{lb}$ 是否超過 0.1？如果是，請降低時間步長或物理流速。
- **檢查點 2**: MRT 的 $s_{ghost}$ 參數是否設為 1.1？如果設為 1.0 或更低，高頻噪音無法消除。
- **檢查點 3**: 建築物邊緣是否過於尖銳？嘗試對 Mask 進行輕微的模糊處理。

**Q3: 即時模擬畫面看起來「一頓一頓」的？**
- **原因**: DL 採樣間隔太大 (例如 0.25s)，導致畫面跳躍。
- **對策**:
    1. 重新生成數據，將 DL 採樣間隔從 500 降至 100~200。
    2. 在渲染端實作 **線性插值 (Linear Interpolation)**。
