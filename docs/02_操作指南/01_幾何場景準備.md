# 01_幾何場景準備

在進行 LBM 模擬之前，必須先準備好幾何遮罩 (Mask)。遮罩檔案決定了流場中的固體邊界，如建築物、圓柱體等。

專案提供兩套生成工具，分別用於簡單測試與高階批量生成。

## 1. 遮罩格式說明

- **格式**: PNG 圖片 (灰階)
- **數值定義**:
  - **黑色 (0)**: 固體障礙物 (Obstacle)
  - **白色 (255)**: 流體區域 (Fluid)
- **座標系**: 圖片左上角為 (0,0)，對應 LBM 模擬的左上角。

> **注意**: `config.yaml` 中的 `mask.invert` 參數可用於反轉此定義 (預設為 `false`)。

---

## 2. 隨機矩形生成器 (`mask_rect_gen.py`)

適用於生成簡單的隨機矩形障礙物，用於初步測試或驗證物理約束。

### 功能特點
- **物理約束**: 設定最小間距 (`MIN_DISTANCE`) 與最大阻塞率 (`MAX_BLOCKAGE_RATIO`)。
- **左對齊**: 強制將生成的最左側物體移動至指定的 Buffer 位置，確保入口流場一致。
- **SDF 檢查**: 使用 Signed Distance Field 避免物體重疊過近。

### 使用方法

```bash
python src/tools/mask_rect_gen.py
```

### 參數設定 (於腳本內修改 `CONFIG` 字典)

```python
CONFIG = {
    "NX": 2048,
    "NY": 1024,
    "RECT_COUNT": [2, 4, 6],       # 每次生成的矩形數量列表
    "NUM_SAMPLES": [20, 20, 10],   # 對應數量的生成張數
    "MIN_DISTANCE": 30,            # 最小間距 (px)
    "MAX_BLOCKAGE_RATIO": 0.4,     # 最大阻塞率 (避免流道堵死)
    "BUFFER": {"LEFT": 128, ...},  # 強制對齊位置
    "OUTPUT_DIR": "src/tools/rect_masks"
}
```

---

## 3. 混合地圖生成器 (`hybrid_map_gen.py`)

適用於生成複雜的混合場景，包含 Pinball (圓柱繞流)、Tube Bank (管束) 與 Urban (隨機城市街區) 三種特徵區域。

### 功能特點
- **多區域混合**: 自動拼接不同流動特徵的區域。
- **特徵長度 (L_char) 計算**: 自動計算 Urban 區域的平均障礙物寬度，作為雷諾數計算基準。
- **檔名嵌入參數**: 生成的檔名包含 `L_char` 數值，方便 `run_multi_case.py` 讀取並動態調整物理參數。

### 使用方法

```bash
python src/tools/hybrid_map_gen.py
```

### 輸出範例

檔名格式: `hybrid_adv_L{L_char}_{id}.png`
- 例如: `hybrid_adv_L125_0000.png` (特徵長度 125px)

### 參數設定 (於腳本內修改 `HYBRID_CONFIG` 字典)

```python
HYBRID_CONFIG = {
    "domain": {"height": 1024, "width": 4096},
    "step_urban": {
        "rect_count": 8,
        "rect_size": {"min_w": 50, "max_w": 200, ...},
        # ...
    },
    "output": {
        "save_dir": "mask/Hyper",
        "invert_values": True, # 輸出時反轉 (0=黑=障礙物)
    }
}
```

---

## 4. 自定義遮罩

您也可以使用任何繪圖軟體 (如 Photoshop, GIMP) 製作遮罩：
1.  新建畫布，尺寸需與 `config.yaml` 中的 `nx`, `ny` 一致 (例如 2048x1024)。
2.  背景填滿白色 (255)。
3.  使用黑色 (0) 繪製障礙物。
4.  儲存為 PNG 格式。
5.  將檔案放入 `src/tools/rect_masks` 或自定義目錄。