# 02_執行模擬指南 (Simulation Guide)

本篇指南說明在新的專案化架構下，如何從遮罩 (Masks) 生成設定檔 (Configs)，並執行最終的批量模擬。

## 1. 核心流程

新的工作流程是一個清晰的三步驟程序：

1.  **生成 Masks**: `hybrid_map_gen.py` -> `SimCases/{project_name}/masks/`
2.  **生成 Configs**: `config_batch_gen.py` -> `SimCases/{project_name}/configs/`
3.  **執行模擬**: `run_multi_case.py` -> `outputs/{project_name}/`

本篇聚焦於步驟 2 與 3。

---

## 2. 步驟 2: 生成模擬設定檔 (`config_batch_gen.py`)

在您生成完遮罩後，此腳本會讀取 `SimCases/{project_name}/masks/` 中的所有遮罩，並為每一個遮罩創建一個對應的 `.yaml` 設定檔。

### 功能特點
- **自動參數解析**: 腳本會從遮罩檔名 (`Re{Re}_L{L_char}_{id}.png`) 中自動讀取目標物理 Re 與特徵長度 L。
- **物理計算**: 根據讀取到的參數與 `master_config.yaml` 中的入口速度 (`u_lb`)，自動計算出模擬所需的晶格黏滯係數 (`nu`)。
- **自動化輸出**: 所有生成的設定檔會被儲存至 `SimCases/{project_name}/configs/`。

### 使用方法

```bash
# 確保你已經為專案生成了 masks
python src/tools/config_batch_gen.py
```

### 輸出結構

```text
SimCases/
└── Hyper/
    ├── masks/
    │   └── Re1000_L120_0000.png
    └── configs/            # 自動生成的設定檔存放於此
        └── cfg_Re1000_L120_0000.yaml
```

---

## 3. 步驟 3: 執行批量模擬 (`run_multi_case.py`)

這是執行所有模擬案例的最終命令。它會自動尋找指定專案的輸入檔案並將結果儲存至標準化的輸出位置。

### 基本指令

您只需要指定 `project_name` 即可。

```bash
python -m src.lbm_mrt_les.runners.run_multi_case --project_name Hyper
```

### 參數說明
- `--project_name`: 指定您要執行的專案名稱。此名稱必須與 `SimCases/` 下的資料夾名稱一致。

### 執行流程
1.  腳本讀取 `--project_name` (例如 `Hyper`)。
2.  它會自動在 `SimCases/Hyper/configs/` 中尋找所有 `.yaml` 設定檔。
3.  對於每一個設定檔，它會讀取其中記錄的遮罩路徑 (例如 `SimCases/Hyper/masks/Re1000_L120_0000.png`)。
4.  執行單次模擬。
5.  所有輸出 (HDF5, 影片, 圖表, 總結檔) 都會被儲存到 `outputs/Hyper/` 對應的子資料夾 (`raw/`, `vis/`, `plots/`)。

---

## 4. 即時視覺化 (GUI) 與影片錄製

若要啟用即時預覽或影片錄製，請修改 `master_config.yaml` 中 `template.outputs` 區塊的設定：

```yaml
template:
  outputs:
    gui:
      enable: true # 設為 true 以啟用即時預覽視窗

    video:
      enable: true # 設為 true 以自動錄製影片
      fps: 30
```

- **GUI 控制**: `Esc` 鍵可終止當前案例並繼續下一個；`s` 鍵可截圖。
- **影片輸出**: 影片會被儲存至 `outputs/{project_name}/vis/`。

> **效能提示**: 在進行大規模數據生成時，建議將 `gui.enable` 與 `video.enable` 設為 `false` 以最大化運算效能。
