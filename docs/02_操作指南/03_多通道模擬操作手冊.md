# 03_多通道模擬操作手冊 (Advanced Batch Processing)

LBM-2D 支援高階的 **批量處理 (Batch Processing)**，特別適用於神經網絡 (Neural Network) 訓練數據的生成。此模式允許同時改變物理參數 (Re) 與幾何形狀 (Mask)，以探索更廣泛的參數空間。

## 1. 原理：Config-Mask 一對一映射

在 `run_multi_case` 模式下，模擬器將讀取兩個資料夾：
1.  **Config Directory (`configs/experiments`)**：包含一系列 `.yaml` 設定檔，定義物理條件。
2.  **Mask Directory (`mask/experiments`)**：包含一系列 `.png` 幾何遮罩。

程式會依檔名排序 (Sort by Name)，將第 `i` 個 Config 與第 `i` 個 Mask 配對執行。這種設計確保了：
- **物理多樣性**: 可以針對每個 Mask 指定不同的雷諾數 (Re)、黏滯係數 (nu) 與解析度。
- **幾何多樣性**: 可以針對每個 Re 測試不同的障礙物形狀與疏密程度。
- **數據完整性**: 輸出檔名會同時包含 Config 與 Mask 的資訊，方便後續標註與追蹤。

---

## 2. 操作流程

### 步驟 1: 生成多樣化 Mask

使用 `hybrid_map_gen.py` 生成一批具有不同特徵長度 (L_char) 的遮罩：

```bash
python src/tools/hybrid_map_gen.py
# Output: mask/Hyper/hybrid_adv_L100_0001.png, hybrid_adv_L120_0002.png ...
```

### 步驟 2: 生成對應 Configs

根據 Mask 的特徵長度 (L_char)，自動生成匹配的 Config 檔案。
使用 `config_batch_gen.py` (需自行實作或使用模板產生器) 來批量建立 `.yaml`。

**關鍵邏輯**:
- 讀取 Mask 檔名中的 `L{L_char}`。
- 設定目標雷諾數 (Re)。
- 計算黏滯係數: `nu = (U_inlet * L_char) / Re`。
- 寫入對應的 `config_L{L_char}_Re{Re}.yaml`。

### 步驟 3: 執行批量模擬

```bash
python -m src.lbm_mrt_les.runners.run_multi_case \
    --config_dir configs/experiments \
    --mask_dir mask/experiments
```

---

## 3. 注意事項

- **檔名排序**: 請確保 Config 與 Mask 的檔名排序邏輯一致 (例如都使用前綴 `001_`, `002_` 或時間戳記)。
- **數量檢查**: 程式啟動前會檢查兩個資料夾內的檔案數量是否完全相同，若不一致會報錯。
- **錯誤處理**: 若某個案例模擬失敗 (如數值發散)，程式會記錄錯誤並跳過，繼續執行下一個案例，不會中斷整個批次。
- **資源釋放**: 每個案例結束後，程式會強制呼叫 Python 垃圾回收 (GC) 與 Taichi 記憶體釋放，避免 GPU 記憶體洩漏 (Memory Leak)。

---

## 4. 輸出結構

每個案例將生成獨立的 HDF5 檔案：
- **路徑**: `outputs/simulation_data/batch_run_hyper/`
- **檔名**: `{ConfigName}_{MaskName}.h5`
- **內容**: 包含該次模擬的所有物理場 (9通道)、SDF 與 Config Metadata。