# 02_系統架構與核心模組 (System Architecture)

本文件詳細說明 `src/lbm_mrt_les` 目錄下的系統架構與程式碼邏輯。此專案實作了一個基於 Taichi 的二維晶格波茲曼方法 (LBM) 流體模擬器，採用多重鬆弛時間 (MRT) 碰撞模型與大渦模擬 (LES) 湍流模型。

## 1. 系統模組概觀

專案採用模組化設計，將物理核心、模擬控制與輸入輸出 (I/O) 分離。

```text
src/lbm_mrt_les/
├── engine/              # 物理核心
│   ├── lbm_solver.py    # LBM MRT-LES 求解器 (核心演算法)
│   └── simulation_ops.py # 模擬迴圈與流程控制 (穩定性檢查)
├── runners/             # 執行入口
│   ├── run_one_case.py  # 單一案例執行腳本
│   └── run_multi_case.py # 批量案例執行腳本
├── io/                  # 輸入輸出
│   ├── lbm_writer.py    # HDF5 數據寫入器 (異步)
│   ├── visualizer.py    # 即時 GUI 渲染器
│   └── video_recorder.py # MP4 影片錄製器
└── utils/               # 工具函式
    ├── mask_utils.py    # 遮罩讀取與處理
    └── config_utils.py  # 設定檔解析
```

---

## 2. 核心求解器 (`LBM2D_MRT_LES`)

位於 `engine/lbm_solver.py`，是整個模擬器的物理引擎。

### 關鍵特性
- **MRT 碰撞模型 (Multiple Relaxation Time)**: 使用 D2Q9 模型，將分佈函數 $f$ 轉換到矩空間 $m$ 進行碰撞，提供比傳統 LBM (BGK) 更優異的數值穩定性，特別是在高雷諾數下。
- **LES 湍流模型 (Large Eddy Simulation)**: 實作 Smagorinsky 次網格模型 (Sub-grid Scale Model)。根據局部應變率動量 (Strain Rate) 動態調整鬆弛時間 $	au_{eff}$，模擬湍流耗散。
- **Sponge Layer (阻尼層)**: 在出口與上下邊界區域施加隱式阻尼，吸收反射波，模擬開放邊界條件。
- **Taichi 加速**: 所有核心運算 (碰撞、串流、邊界處理) 皆使用 `@ti.kernel` 裝飾，自動編譯為 GPU CUDA 代碼。

### 核心運算流程
1.  **Collide & Stream**: 執行 MRT 碰撞運算與粒子串流。
2.  **Update Macro**: 計算巨觀物理量 (密度、速度)。
3.  **Apply BC**: 應用邊界條件 (Inlet, Outlet, Wall) 與障礙物遮罩。

---

## 3. 模擬控制與穩定性 (`simulation_ops.py`)

負責管理模擬的主迴圈 (Main Loop)，協調 Solver 計算與 I/O 輸出。

### 穩定性熔斷機制 (Stability Fuses)
為了確保自動化批量生產的數據品質，系統會實時監控以下指標，一旦異常立即終止模擬並報錯：
1.  **NaN/Inf Check**: 檢查全場是否有非數值 (爆掉)。
2.  **Velocity Limit**: 檢查最大流速是否超過 LBM 極限 (Mach number < 0.577)。設有 `warmup_steps` 容許初始震盪。
3.  **Force Explosion**: 檢查障礙物受力是否異常激增。

---

## 4. 數據輸出模組 (`io/lbm_writer.py`)

負責將模擬數據高效地寫入硬碟。

- **異步寫入 (Async I/O)**: 使用 Python `threading` 與 `queue`，將 HDF5 寫入操作移至背景執行緒，避免阻塞 GPU 計算迴圈。
- **MRT Moments**: 完整輸出 9 個 MRT 矩分量 (rho, e, eps, jx, qx, jy, qy, pxx, pxy)，保留最完整的物理資訊供神經網絡學習。
- **Static Mask**: 儲存幾何遮罩與 SDF (Signed Distance Field)。
- **Accumulated Stats**: 計算並輸出累積渦度 (`sum_vor`) 與時序平均場。

---

## 5. 邊界條件實現

| 邊界類型 | 描述 | 物理意義 | 實現細節 |
| :--- | :--- | :--- | :--- |
| **0: Velocity Inlet** | 速度入口 | Dirichlet | 若為左邊界，預設為 **Parabolic Profile** (拋物線) 以模擬完全發展流；其餘為 Uniform。 |
| **1: Outflow** | 壓力出口 | Neumann | 零梯度條件 (Zero Gradient)，速度與密度直接複製鄰居節點。配合 Sponge Layer 使用。 |
| **2: Free Slip** | 滑移壁面 | Symmetry | 切向速度保留，法向速度歸零 (類似鏡像反射)。 |
| **3: No Slip** | 無滑移壁面 | Wall | 固壁。速度強制為 0 (標準 Bounce-back)。 |

---

## 6. 開發者注意事項

- **座標系**: Taichi 使用 `(i, j)` 索引對應 `(x, y)`。但在輸出到 HDF5 或 OpenCV 時，需注意轉置 (`transpose`) 以符合 `(Height, Width)` 的影像慣例。
- **單位轉換**: LBM 使用晶格單位 (Lattice Units)。設定檔中的 `nu` (黏滯係數) 與 `value` (入口速度) 皆為無因次化的 LBM 單位。
- **效能**: 在高解析度 (2048x1024) 下，建議關閉 GUI 與 Video 錄製，以獲得最大 FPS。
