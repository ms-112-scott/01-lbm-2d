# 02_系統架構與核心模組 (System Architecture)

本文件詳細說明 `src/lbm_mrt_les` 目錄下的系統架構與程式碼邏輯。此專案透過清晰的模組化設計，將物理計算、流程控制、數據 I/O 與工具函式庫進行了有效分離。

## 1. 系統模組概觀

專案採用了關注點分離 (Separation of Concerns) 的設計原則，將不同職責的程式碼組織在獨立的模組中。

```text
src/lbm_mrt_les/
├── core/                  # 物理核心 (Physics Core)
│   ├── LBM2D_MRT_LES.py   # LBM MRT-LES 求解器 (核心演算法)
│   └── simulation_ops.py  # 模擬主迴圈與穩定性檢查
│
├── pipeline/              # 高階流程控制 (High-Level Workflow)
│   ├── batch_run.py       # 批量模擬的唯一入口點 (Entry Point)
│   ├── case_executor.py   # 封裝單一案例的完整執行流程
│   ├── summary_builder.py # 建立並結構化最終的 summary 資料
│   ├── paths.py           # 管理所有專案相關的路徑規則
│   └── run_one_case.py    # 單一案例的基礎執行函式
│
├── io/                    # 底層數據讀寫 (Low-Level I/O)
│   ├── LBM_Writer.py      # HDF5 數據異步寫入器
│   ├── Video_Recorder.py  # MP4 影片錄製器
│   ├── batch_io.py        # 負責寫入 all_cases_summary.json
│   └── NumpySafeJSONEncoder.py # 處理 NumPy 型別的 JSON 編碼器
│
├── visualization/         # 視覺化相關 (Visualization)
│   ├── Taichi_Gui_Viz.py  # 即時 GUI 渲染器
│   ├── color_utils.py     # 色彩映射表
│   └── viz_utils.py       # 視覺化輔助函式
│
└── utils/                 # 通用工具函式 (Shared Utilities)
    ├── config_utils.py    # 設定檔解析
    ├── mask_utils.py      # 遮罩讀取與處理
    ├── physics_scaling.py # 晶格單位與物理單位的換算
    └── system_utils.py    # 系統相關工具 (如快取清理)
```

---

## 2. 核心求解器 (`core/`)

此模組是整個模擬器的物理引擎，負責所有底層的流體力學計算。

### `LBM2D_MRT_LES.py`
- **MRT 碰撞模型**: 使用 D2Q9 模型，將分佈函數轉換到矩空間進行碰撞，提供優異的數值穩定性。
- **LES 湍流模型**: 實作 Smagorinsky 次網格模型，動態調整鬆弛時間以模擬湍流耗散。
- **Sponge Layer (阻尼層)**: 在出口與上下邊界區域施加隱式阻尼，吸收反射波。
- **Taichi 加速**: 所有核心運算皆使用 `@ti.kernel` 裝飾，編譯為高效的 GPU CUDA 代碼。

### `simulation_ops.py`
- **模擬主迴圈 (Main Loop)**: 管理模擬的迭代，協調 Solver 計算與 I/O 輸出。
- **穩定性熔斷機制**: 實時監控 NaN/Inf、流速過快等指標，確保數據品質，在數值發散時自動終止。

---

## 3. 流程控制 (`pipeline/`)

此模組是使用者與系統互動的主要介面，負責 orchestrate 整個批量模擬的生命週期。

- **`batch_run.py`**: **唯一的執行入口**。負責解析命令列參數 (`--project_name`)，並啟動整個流程。
- **`paths.py`**: 集中管理所有路徑邏輯，確保輸入 (`SimCases/`) 與輸出 (`outputs/`) 的路徑一致性。
- **`case_executor.py`**: 封裝了執行 **單一案例** 的所有步驟：準備路徑、呼叫 `run_one_case`、計算物理參數、建立總結，是 `batch_run.py` 的主要工作單元。
- **`summary_builder.py`**: 負責將零散的模擬結果 (晶格參數、物理參數、檔案路徑等) 組裝成一個結構清晰、可讀性高的字典。

---

## 4. 數據輸出 (`io/`) 與單位換算 (`utils/physics_scaling.py`)

### `io/`
- **`LBM_Writer.py`**: 使用背景執行緒**異步寫入** HDF5，避免 I/O 操作阻塞 GPU 計算，並完整輸出 9 個 MRT 矩。
- **`batch_io.py`**: 專門負責將最終的 `all_cases_summary` 列表寫入 `.json` 檔案，並使用 `NumpySafeJSONEncoder` 確保數據格式正確。

### `utils/physics_scaling.py`
- **晶格-物理單位換算**: 此模組是連接模擬世界與真實世界的橋樑。它根據 `master_config.yaml` 中定義的物理常數 (如風速、空氣黏滯係數)，計算出 **晶格單位 (Lattice Units)** 與 **物理單位 (Physical Units, e.g., meters, seconds)** 之間的換算比例，並將所有模擬結果轉換為真實世界的物理量。

---

## 5. 邊界條件與開發者注意事項

(此部分內容與舊版文件相同，僅作保留)

| 邊界類型 | 描述 | 物理意義 | 實現細節 |
| :--- | :--- | :--- | :--- |
| **0: Velocity Inlet** | 速度入口 | Dirichlet | 若為左邊界，預設為拋物線剖面；其餘為均勻流。 |
| **1: Outflow** | 壓力出口 | Neumann | 零梯度條件，配合 Sponge Layer 使用。 |
| **2: Free Slip** | 滑移壁面 | Symmetry | 切向速度保留，法向速度歸零。 |
| **3: No Slip** | 無滑移壁面 | Wall | 標準 Bounce-back。 |

- **座標系**: Taichi 使用 `(i, j)` 索引對應 `(x, y)`。輸出時需注意轉置 (`transpose`) 以符合影像 `(Height, Width)` 的慣例。
- **效能**: 在進行大規模數據生成時，建議關閉 GUI (`gui.enable: false`) 與影片錄製 (`video.enable: false`) 以最大化運算效能。
